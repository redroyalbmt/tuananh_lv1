<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
    crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="sweetalert2.js"></script>
</head>
<body>
<!-- modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="loginModalLabel">Login Modal</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="email" placeholder="Email" class="form-control mb-2">
        <input type="text" id="api_token" placeholder="apitoken" class="form-control">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="checkloginbtn">Login</button>

      </div>
    </div>
  </div>
</div>
<!-- end modal -->
<!-- edit modal -->
<div class="modal fade" id="editTodoModal" tabindex="-1" aria-labelledby="editTodoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editTodoModalLabel">Thay đổi To Do</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="editTodoIpt" placeholder="" class="form-control mb-2">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">close</button>
        <button type="button" class="btn btn-primary" id="submitedit">Lưu</button>
          </div>
      </div>
    </div>
  </div>
<!-- end edit modal -->
<!-- navbar  -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Navbar</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">

        <li class="nav-item">
          <a class="nav-link" id="loginbtn">Login</a>
        </li>
        <li class="nav-item" id="logoutLI">
          <a href="#" class="nav-link" id="logoutbtn">Logout</a>
        </li>
      </ul>
      <div class="d-flex mt-2">
        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
      </div>
      <div class="d-flex mt-2">
        <input class="form-control me-2" type="search" id="TodoInput" placeholder="them todo" aria-label="Search">
        <button class="btn btn-outline-success" type="submit" id="addtodobtn">Thêm</button>
      </div>
    </div>
  </div>
</nav>

<!-- table -->
<div class="container w-70">
  <div class="table-responsive mt-3">
    <table class="table table-striped table-hover table-borderless table-primary">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Todo</th>
          <th>Hoàn thành</th>
          <th>Tùy chỉnh</th>
        </tr>
      </thead>
      <tbody class="table-group-divider" id="resulttable">
        <tr class="table-primary">
          <Td scope="row" colspan="4">
            <b>Chưa có danh mục được tạo</b>
          </Td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
<script>
  const CHECKLOGIN_API = "https://students.trungthanhweb.com/api/checkLoginhtml?email=leodomsolar@gmail.com";
  const CREATETODO_API = "https://students.trungthanhweb.com/api/todo";
  const Toast = Swal.mixin({
    toast: true,
    position: 'top-end',
    showConfirmButton: false,
    timer: 1200,
    timerProgressBar: true,
    didOpen: (toast) => {
      toast.addEventListener('mouseenter', Swal.stopTimer)
      toast.addEventListener('mouseleave', Swal.resumeTimer)
    },
  });
  $(document).ready(function () {
    checklogin();
    addtodo();
    loadtodo();
    editTodo();
    deleteTodo();
    checklogout();
   
  });
  // login
  function checklogin() {
    if (!localStorage.getItem("token") && localStorage.getItem("token") == null) {
      $("#api_token").hide();
    } else {
      $("#email").hide();
      $("#api_token").val(localStorage.getItem("token"));
    }
    $("#loginbtn").click(function (e) { 
      e.preventDefault();
          $("#loginModal").modal("show");
          $("#checkloginbtn").click(function (e) {
      
      e.preventDefault();
      let email = $("#email").val().trim();
      if (email == "") {

        Toast.fire({
          icon: 'error',
          title: 'chưa nhập email',
        });
      } else {
        $.ajax({
          type: "POST",
          url: CHECKLOGIN_API,
          data: {
            email: email
          },
          dataType: "JSON",
          success: function (response) {
            console.log(response);
            if (response.check == true) {
              if (!localStorage.getItem("token") && localStorage.getItem("token") == null) {
                localStorage.setItem("token", response.apitoken);
              }
              // in thong bao dau ra

              Toast.fire({
                icon: 'success',
                title: 'Đăng nhâp thành công',
              }).then(() => {
                window.location.reload();
              });
            }
            // ket thuc in thong bao(
            if (response.msg.email) {

              Toast.fire({
                icon: 'error',
                title: response.msg.email,
              });
            }
          }

        })
      }
    });
  
    });
  }
  // end login
  // logout

  function checklogout() {

    if (!localStorage.getItem("token") && localStorage.getItem("token") == null) {
      $("#logoutLI").hide();
    } else {
      $("#loginbtn").text('API');
    }
    $("#logoutbtn").click(function (e) {
      
      e.preventDefault();;
      if (!localStorage.removeItem("token") && localStorage.removeItem("token") == null) {
        localStorage.removeItem('token');
        Toast.fire({
          icon: 'success',
          title: 'Logout thành công',
        }).then(() => {
          window.location.reload();
        });

      }
    });
  }

  // end logout
  // add todo
  function addtodo() {
    $("#addtodobtn").click(function (e) {
      e.preventDefault();
      let todo = $("#TodoInput").val().trim();
      if (todo == "") {
        Toast.fire({
          icon: "error",
          title: "Chưa Có To DO",
        });

      } else {
        $.ajax({
          type: "POST",
          url: CREATETODO_API,
          data: {
            apitoken: localStorage.getItem("token"),
            todo: todo,


          },
          dataType: "JSON",
          success: function (response) {
            // trang thai tra ve todo thanh cong
            if (response.check == true) {
              Toast.fire({
                icon: "success",
                title: "da them thanh cong",
              }).then(() => {
                window.location.reload();
              });
            }
            // trang thai tra ve todo that bai
            if (response.msg.apitoken) {
              Toast.fire({
                icon: "error",
                title: response.msg.apitoken,
              });
            } else if (response.msg.todo) {
              Toast.fire({
                icon: "error",
                title: response.msg.todo,
              });
            }
          }
        });
      }
    });
  }
  // end addtodo
  // loaddata
  function loadtodo() {
    $.ajax({
      type: "GET",
      url: CREATETODO_API,
      data: {
        apitoken: localStorage.getItem("token"),

      },
      dataType: "JSON",
      success: function (response) {
        if (response.todo && response.todo.length > 0) {
          var str = ``;
          response.todo.forEach((el, key) => {
            if (el["status"] == 0) {
              str += `
                      <tr class="table-primary">
                        <td scope="row">`+
                ++key +
                `</td>
                            <td>`+
                el["note"] +
                `</td>
                              <td>
                                <input type="checkbox" class="donecheck" data-id="` +
                el["id"] +
                `">
                                </td>
                                <td>
                                  <button class="btn-sm btn-danger deleteTodoBtn" data-id="`+
                el["id"] +
                `">Xóa</button>
                                  <button class="btn-sm btn-warning editTodoBtn" data-value="`+
                el["note"] +
                `"data-id="` +
                el["id"] +
                `">Sửa</button>
                                  </td>
                                  </tr>
                                  `;
            }
          
        });
          $("#resulttable").html(str);
          deleteTodo();
          editTodo();
          // donetask();
        }
      }
    });
  }
  // end loaddata'
  // editdata
  function editTodo(){
    $(".editTodoBtn").click(function (e) {
      e.preventDefault();
      var old = $(this).attr("data-value");
      var id = $(this).attr("data-id");
      console.log("this:  ", this);
      console.log("old:  ", old);
      console.log("id:  ", id);
      $("#editTodoIpt").val(old);
      $("#editTodoModal").modal("show");
      $("#submitedit").click(function (e) { 
        
        e.preventDefault();
        var todo = $("#editTodoIpt").val().trim();
        if(todo==""){
          Toast.fire({
          icon: "error",
          title: "Chưa nhập nội dung to do",
        });
        }else{
          $.ajax({
            type: "POST",
            url: "https://students.trungthanhweb.com/api/updatetodo",
            data: {
              apitoken:localStorage.getItem("token"),
              id : id,
              todo : todo,
            },
            dataType: "JSON",
            success: function (response) {
              if(response.check==true){
                Toast.fire({
          icon: "success",
          title: "Đã Thay Đổi thành công",
        }).then(() => {
                window.location.reload();
              });
            }
            if (response.msg.apitoken) {
              Toast.fire({
                icon: "error",
                title: response.msg.apitoken,
              });
            } else if (response.msg.todo) {
              Toast.fire({
                icon: "error",
                title: response.msg.todo,
              });
            }
          }
          });
        }
      });
    });
  }
//  end editTodo
// function deleteTodo(){
//   $(".deleteTodoBtn").click(function (e) { 
//     e.preventDefault();
//     var id=$(this).attr("data-id");
//     Swal.fire({
//       icon:"question",
//       text : "Xoa Todo ?",
//       showDenyButton:true,
//       showCancelButton:false,
//       confirmButtonText:"Đúng",
//       denyButtonText:"không",
//     }).then((result)=>{
//         if(result.inconfirmed){
//           $.ajax({
//             type: "POST",
//             url: "https://students.trungthanhweb.com/api/deletetodo",
//             data: {
//               apitoken: localStorage.getItem("token"),
//               todo: todo,
              
//             },
//             dataType: "JSON",
//             success: function (response) {
//               if (response.check == true){
//                 Toast.fire({
//                 icon: "success",
//                 title: "da them thanh cong",
//               }).then(() => {
//                 window.location.reload();
//               });
//               }
//               if (response.msg.apitoken) {
//               Toast.fire({
//                 icon: "error",
//                 title: response.msg.apitoken,
//               });
//             } else if (response.msg.todo) {
//               Toast.fire({
//                 icon: "error",
//                 title: response.msg.todo,
//               });
//             }
//             }
//           });
//         }
//     })
//   });
// }
function deleteTodo(){
  $(".deleteTodoBtn").click(function (e) { 
    e.preventDefault();
    var id=$(this).attr("data-id");
    Swal.fire({
  title: 'Bạn Có Thực Sự muốn xóa?',
  showDenyButton: true,
      icon:"warning",
  confirmButtonText: 'Yes',
  denyButtonText: 'No',
  customClass: {
    actions: 'my-actions',
    cancelButton: 'order-1 right-gap',
    confirmButton: 'order-2',
    denyButton: 'order-3',
  }
}).then((result) => {
  if (result.isConfirmed) {
    $.ajax({
      type: "POST",
      url: "https://students.trungthanhweb.com/api/deletetodo",
      data: {
        apitoken: localStorage.getItem("token"),
            id:id,
      },
      dataType: "JSON",
      success: function (response) {
        if (response.check == true) {
              Toast.fire({
                icon: "success",
                title: "Đã Xóa Thành Công",
              }).then(() => {
                window.location.reload();
              });
            }
            if (response.msg.apitoken) {
              Toast.fire({
                icon: "error",
                title: response.msg.apitoken,
              });
            } else if (response.msg.todo) {
              Toast.fire({
                icon: "error",
                title: response.msg.todo,
              });
            }
      }
    });
  } else if (result.isDenied) {
    Swal.fire('Bạn muốn lưu lại', '', 'info')
  }
})
})
}
</script>

</body>

</html>