<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thanh Toán</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="css/stylectsp.css">
<script src="js/alert.js"></script>
<script src="js/code.jquery.com_jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body>
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="loginModalLabel">Login Modal</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="text" id="email" placeholder="Email" class="form-control mb-2">
              <input type="text" id="api_token" placeholder="apitoken" class="form-control">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" id="checkloginbtn">Login</button>
      
            </div>
          </div>
        </div>
      </div>
      <!-- end modal -->
      <!-- edit modal -->
      <div class="modal fade" id="ThanhToanModal" tabindex="-1" aria-labelledby="ThanhToanModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="ThanhToanModalLabel">Thông Tin Thanh Toán</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="text" class="form-control w-100 mb-2" id="tenKH" placeholder="Tên khách hàng ">
              <input type="text" class="form-control w-100 mb-2" id="phone" placeholder="Số điện thoại ">
              <input type="text" class="form-control w-100 mb-2" id="address" placeholder="Địa chỉ ">
              <td><span id="productname"></span></td>

            



              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">close</button>
              <button type="button" class="btn btn-primary" id="submitCheckOut">Đặt Hàng</button>
                </div>
            </div>
          </div>
        </div>
      <!-- end edit modal -->
    <nav class="navbar navbar1 navbar-expand-sm navbar-dark bg-secondary">
        <div class="container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse w-100" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-sm-0">
              <li class="nav-item">
                <a class="active" aria-current="page" href="#">
                    <img class="logo"src="img/Capture.PNG">
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="index.html">Home</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                  Thương Hiệu
                </a>
                <ul class="dropdown-menu" id="brandsUL" aria-labelledby="navbarDropdown">
                 
                </ul>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="
                margin-top: -2px;
            ">
                  Loại sản Phẩm
                </a>
                <ul class="dropdown-menu" id="loaispUL" aria-labelledby="navbarDropdown">
                  
                </ul>
              </li>
              <form class="d-flex" style="    margin-left: 506;margin-top: 2px;">
               <a href="bill.html"> <button class="btn btn-warning ms-3 " type="button"style="height:35px">
                  
                    Hóa Đơn
                </button> </a>


              </form>
            </ul>
            <form class="d-flex">
              <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search">
              <button class="btn btn-outline-success" type="submit">Search</button>          
 
            </form>
  <div class="d-flex1">
                <button class="btn btn-warning ms-3 " type="button" id="loginbtn">Đăng Nhập</button> 
                <button class="btn btn-warning ms-2 " type="button" id="logoutbtn">Đăng Xuất</button> 
              </div>
              

          </div>
        </div>
    </nav>
    <div class="container mt-4">
        <div class="table-responsive desktopcart">
                                <table class="table table-primary">

                <thead class="table-dark">
                    <tr>
                        <th scope="col">STT</th>
                        <th scope="col">Hình ảnh</th>
                        <th scope="col">Tên</th>
                        <th scope="col">Giá</th>
                        <th scope="col" style="width:10%">Số lượng</th>
                        <th scope="col">Thành tiền</th>
                        <th scope="col">Xóa</th>

                    </tr>
                </thead>
                <tbody id="cartressult">

                </tbody>
            </table>
        </div>
        <div class="mobicart">
            <div class="accordion accordion-flush" id="accordionFlushCart">
               
            </div>
        </div>
        <div class="row">
            <div class="col-md-2">
                <button class="btn btn-primary w-100" id="checkoutBtn">Thanh toán</button>
            </div>
        </div>

    </div>
    <footer>
        <div class="footer1">
          <div class="container">
            <div class="row">
               
               <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4 text-center">
                  <h3>LOCATION</h3>
                  <p>77 Lê Trung Nghĩa<br>P.12.Tân Bình</p>
               </div>
               <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4 text-center">
                <h3>FANPAGE</h3>
                <ul>
                  <li><a href="" class="fa fa-facebook"></a>  </li>
                  <li><a href="" class="fa fa-google-plus"></a>  </li>
                  <li><a href="" class="fa fa-twitter"></a>  </li>
                  <li><a href="" class="fa fa-linkedin"></a>  </li>
                  <li><a href="" class="fa fa-dribbble"></a>  </li>
                </ul>
              </div>
              <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4 text-center">
                <h3>CONTACT</h3>
              <p>LE TUAN ANH <br> 09123456789</p>
      
              </div>
            </div> 
            <!-- end row -->
          </div>
          <!-- end container -->
        </div>
         <!-- and fotter 1 -->
        <div class="footer2">
        <div class="container text-center">
            <p>copyright @ Your Website Tuan Anh</p>
        </div>
      </div>
      </footer>
    <script>
      $(document).ready(function () {
           logout(); loadCart();
          CheckOut();
       
      });
      const url = 'https://students.trungthanhweb.com/api/';
////in thong bao
      const Toast = Swal.mixin({
          toast: true,
          position: 'top-end',
          showConfirmButton: false,
          timer: 1700,
          timerProgressBar: true,
          didOpen: (toast) => {
              toast.addEventListener('mouseenter', Swal.stopTimer)
              toast.addEventListener('mouseleave', Swal.resumeTimer)
          }
      })

 

     
      ////checkout
      function CheckOut() {
          $("#checkoutBtn").click(function (e) {
              e.preventDefault();
              $("#ThanhToanModal").modal('show');
              const format = /(0[3|5|7|8|9])+([0-9]{8})\b/g
              $("#submitCheckOut").click(function (e) {
                  e.preventDefault();
                  var tenKH = $("#tenKH").val().trim();
                  var phone = $("#phone").val().trim();
                  var address = $("#address").val().trim();

                  var name = $("#productname").val();



                  if (tenKH == '') {
                      Toast.fire({
                          icon: 'warning',
                          title: 'Thiếu Tên Nhé??'
                      })
                      
                      
                  } else if (phone == '') {
                      Toast.fire({
                          icon: 'warning',
                          title: 'Thiếu STD Nhé'
                      })
                      
                  } else if (address == '') {
                      Toast.fire({
                          icon: 'warning',
                          title: 'Quên Địa Chỉ Kìa ?'
                      })
                      
                 
                  } else if (!phone.match(format)) {
                      Toast.fire({
                          icon: 'warning',
                          title: 'Số Không Có !!!'
                      })
                    
                
                 
                  } else {
                      $("#submitCheckOut").attr('disabled', 'disabled');
                      var cart = localStorage.getItem('cart');
                      $.ajax({
                          type: "POST",
                          url: url + "createBill",
                          data: {
                              tenKH: tenKH,
                              phone: phone,
                              address: address,
                              
                              cart: cart,
                              apitoken: localStorage.getItem('token')
                          },
                          dataType: "JSON",
                          success: function (res) {
                              if (res.check == true) {
                                  Toast.fire({
                                      icon: 'success',
                                      title: 'Đặt hàng thành công'
                                  }).then(() => {
                                      localStorage.removeItem('cart');
                                      window.location.assign('bill.html');
                                  })
                              }
                          }
                      });
                  }
              });
          });
      }
      ////logout
      function logout() {

if (!localStorage.getItem("token") && localStorage.getItem("token") == null) {
  $("#logoutbtn").hide();
  $("#showmorebtn").hide();
} else {
  $("#loginbtn").hide();
}
$("#logoutbtn").click(function (e) {
  
  e.preventDefault();;
  if (!localStorage.removeItem("token") && localStorage.removeItem("token") == null) {
    localStorage.removeItem('token');
    Toast.fire({
      icon: 'success',
      title: 'Tạm Biệt',
    }).then(() => {
        window.location.assign("index.html");
    });

  }
});
}
//////     
      var link = url + 'home'; //noi chuoi 
      // 
      function loadCart() {
          if (localStorage.getItem('cart') && localStorage.getItem('cart') != null) {
              var cart = localStorage.getItem('cart');
              
              $.ajax({
                  type: "GET",
                  url: url + "getCart",
                  data: {
                      apitoken: localStorage.getItem('token'),
                      id: cart,
                  },
                  dataType: "JSON",
                  success: function (res) {
                      if (res.check == true) {
                          const brands = res.brands;
                          const categrories = res.categrories;
                          if (brands.length > 0) {
                              var str = ``;
                              brands.forEach(el => {
                                  str += `
                                  <li><a class="dropdown-item" href="brands.html?id=`+el.id+`">`+ el.name + `</a></li>
                              `
                              });
                              $("#brandsUL").html(str);
                          }
                          if (categrories.length > 0) {
                              var str = ``;
                              categrories.forEach(el => {
                                  str += `
                              <li><a class="dropdown-item" href="categrories.html?id=`+ el.id + `">` + el.name + `</a></li>
                              `
                              });
                              $("#loaispUL").html(str);
                          }
                          if (res.result.length > 0) {
                              var str = ``;
                              var str2 = ``;
                              var sum = 0;
                              var i=0;
                              res.result.forEach((el, index) => {
                                  if (index % 2 == 0) {
                                      str += `
                              <tr class="table-primary">
                                  <td class="table-borderless" scope="row">`+ (++index) + `</td>
                                  <td class="table-borderless"><img src="`+ el[3] + `" style="width:150px;height: auto;" alt=""></td>
                                  <td class="table-borderless">`+ el[1] + `</td>
                                  <td class="table-borderless">`+ Intl.NumberFormat('en-US').format(el[2]) + `</td>
                                  <td  class="table-borderless"> <input type="number" class="form-control qtyinput" value="`+ el[4] + `" data-id="` + el[0] + `" ></td>
                                  <td class="table-borderless">`+ Intl.NumberFormat('en-US').format(el[6]) + `</td>
                                  <td>
                                      <button class="btn-sm btn-danger deleteCartItem" data-id="`+ Number(el[0]) + `">Xóa </button>
                                  </td>
                                  <
                              </tr>
                              `;
                                      str2 += `
                                      <div class="accordion-item">
                                  <h2 class="accordion-header" id="flush-heading`+(i)+`">
                                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse`+(i)+`" aria-expanded="false" aria-controls="flush-collapse`+(i)+`">
                                      <h4>`+ el[1] + `</h4>
                                      </button>
                                  </h2>
                                  <div id="flush-collapse`+(i)+`" class="accordion-collapse collapse" aria-labelledby="flush-heading`+(i)+`" data-bs-parent="#accordionFlushCart">
                                      <div class="accordion-body">
                                          <img src="`+ el[3] + `" alt="" class="w-50">
                                          <h4>Tên sản phẩm : `+ el[1] + `</h4>
                                          <h4>Giá : `+ Intl.NumberFormat('en-US').format(el[5]) + `</h4>
                                          <div class="mb-3">
                                          <label for="" class="form-label">Số lượng</label>
                                          <input type="number" class="form-control qtyinput" value="`+ el[4] + `" data-id="` + el[0] + `" >
                                          </div>
                                          <div class="mb-3">
                                              <label for="" class="form-label">Thành tiền</label>
                                              <input type="text" readonly name="" id=""  value="`+Intl.NumberFormat('en-US').format(el[6])+`" class="form-control">
                                          </div>
                                      </div>
                              </div>
                              </div>
                              `
                                  } else {
                                      str += `
                              <tr class="table-secondary">
                                  <td class="table-borderless" scope="row">`+ (++index) + `</td>
                                  <td class="table-borderless"><img src="`+ el[3] + `" style="width:150px;height: auto;" alt=""></td>
                                  <td class="table-borderless">`+ el[1] + `</td>
                                  <td class="table-borderless">`+ Intl.NumberFormat('en-US').format(el[2]) + `</td>
                                  <td  class="table-borderless"> <input type="number" class="form-control qtyinput" value="`+ el[4] + `" data-id="` + el[0] + `" ></td>
                                  <td class="table-borderless">`+ Intl.NumberFormat('en-US').format(el[6]) + `</td>
                                  <td>
                                      <button class="btn-sm btn-danger deleteCartItem" data-id="`+ Number(el[0]) + `">Xóa </button>
                                  </td>   
                              </tr>
                              `;
                              str2 += `
                              <div class="accordion-item">
                                  <h2 class="accordion-header" id="flush-heading`+(i)+`">
                                      <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapse`+(i)+`" aria-expanded="false" aria-controls="flush-collapse`+(i)+`">
                                      <h4>`+ el[1] + `</h4>
                                      </button>
                                  </h2>
                                  <div id="flush-collapse`+(i)+`" class="accordion-collapse collapse" aria-labelledby="flush-heading`+(i)+`" data-bs-parent="#accordionFlushCart">
                                      <div class="accordion-body">
                                          <img src="`+ el[3] + `" alt="" class="w-50">
                                          <h4>Tên sản phẩm : `+ el[1] + `</h4>
                                          <h4>Giá : `+ Intl.NumberFormat('en-US').format(el[5]) + `</h4>
                                          <div class="mb-3">
                                          <label for="" class="form-label">Số lượng</label>
                                          <input type="number" class="form-control qtyinput" value="`+ el[4] + `" data-id="` + el[0] + `" >
                                          </div>
                                          <div class="mb-3">
                                              <label for="" class="form-label">Thành tiền</label>
                                              <input type="text" readonly name="" id=""  value="`+Intl.NumberFormat('en-US').format(el[6])+`" class="form-control">
                                          </div>
                                      </div>
                              </div>
                              </div>
                              `
                              console.log();
                                  }

                                  sum += el[6];
                                  i++;
                              });
                              str += `
                          <tr class="table-dark">
                              <td colspan='5' class="table-borderless" scope="row">Tổng tiền</td>
                              <td class="table-borderless">`+ Intl.NumberFormat('en-US').format(sum) + `</td>
                              <td class="table-borderless" scope="row"></td>

                          </tr>
                          `
                              str2+=`
                              <div class="mb-3">
                                  <label for="" class="form-label">Tổng tiền</label>
                                  <input type="text" name="" id="" readonly class="form-control" value="`+ Intl.NumberFormat('en-US').format(sum) + `" placeholder="" aria-describedby="helpId">
                              </div>
                              `;
                              $("#cartressult").html(str);
                              $("#accordionFlushCart").html(str2);

                          }
                          editQuantity();
                          deleteCart();
                      } else {
                          str = `
                      <tr class="table-dark">
                          <td colspan='7' class="table-borderless" scope="row">Chưa có sản phẩm</td>
                      </tr>
                      `;
                          $("#cartressult").html(str);

                      }
                  }
              });
          } else {
              window.location.replace('index.html?err=emtycart');
          }
      }
      function deleteCart() {
          $(".deleteCartItem").click(function (e) {
              e.preventDefault();
              Swal.fire({
                  icon: 'question',
                  text: 'Xóa sản phẩm khỏi giỏ hàng?',
                  showDenyButton: true,
                  showCancelButton: false,
                  confirmButtonText: 'Xóa',
                  denyButtonText: `Không`,
              }).then((result) => {
                  if (result.isConfirmed) {
                      var id = $(this).attr('data-id');
                      var arr = [];
                      console.log(id);
                      var cart = JSON.parse(localStorage.getItem('cart'));
                      cart.forEach(el => {
                          if (el[0] != id) {
                              arr.push(el);
                          }
                      });
                      if (arr.length == 0) {
                          localStorage.removeItem('cart');
                      } else {
                          localStorage.setItem('cart', JSON.stringify(arr));
                      }
                      Toast.fire({
                          icon: 'success',
                          title: 'Đã xóa khỏi giỏ hàng'
                      }).then(() => {
                          loadCart();
                      })
                  } else if (result.isDenied) {

                  }
              })

          });
      }
      function editQuantity() {
          $(".qtyinput").change(function (e) {
              e.preventDefault();
              var id = $(this).attr('data-id');
              var qty = $(this).val();
              var cart = JSON.parse(localStorage.getItem('cart'));
              if (qty == 0) {
                  Swal.fire({
                      icon: 'warning',
                      text: 'Xóa khỏi giỏ hàng?',
                      showDenyButton: true,
                      showCancelButton: false,
                      confirmButtonText: 'Đúng',
                      denyButtonText: `Không`,
                  }).then((result) => {
                      if (result.isConfirmed) {
                          var arr = [];
                          cart.forEach(el => {
                              if (el[0] != id) {
                                  arr.push(el);
                              }
                          });
                          if (arr.length == 0) {
                              localStorage.removeItem('cart');
                          } else {
                              localStorage.setItem('cart', JSON.stringify(arr));
                          }

                          Toast.fire({
                              icon: 'success',
                              title: 'Đã xóa !'
                          }).then(() => {
                              loadCart()
                          })


                      } else if (result.isDenied) {
                          loadCart();
                      }
                  })
              } else {
                  cart.forEach(el => {
                      if (el[0] == id) {
                          el[1] = qty;
                      }
                  });
                  localStorage.setItem('cart', JSON.stringify(cart));
              }
              loadCart();
          });
      }
  </script>


</body>
</html>